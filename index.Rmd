--- 
title: "Brandon Road Interbasin Project Risk Analysis Report"
author: "USACE Rock Island District"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
description: "Report description goes here."
bibliography: [book.bib, packages.bib]
biblio-style: apalike
csl: chicago-fullnote-bibliography.csl
---

# Introduction {-}

## Project 
* P2 project name: Brandon Rd-Great Lakes/Miss Rvr Interbasin
* P2 project number: 482782
* P2 program code: 451617

<!-- Libraries -->
```{r library, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(knitr)
library(rmarkdown)
library(lubridate)
library(tools)
library(kableExtra)
library(pander)
library(timevis)
```

```{r source, echo=FALSE, warning=FALSE, message=FALSE}
source("R/risk_register_table.R")
```

<!-- chunk options -->
```{r chunk-opts], echo=FALSE, warning=FALSE, message=FALSE}
options(width = 60)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE
  )
```

<!-- Report Constants -->
```{r}
qa_email_address <- "Michael.P.Dougherty@usace.army.mil"
```

<!-- Wrangle Data -->
```{r wrangle-risk, echo=FALSE, warning=FALSE, message=FALSE}
risk_oracle <- read_csv(file = "data/RR_Main_Report_View.csv")

# Set date fields
risk <- risk_oracle %>%
  mutate(start_date = lubridate::as_date(START_DATE)) %>%
  mutate(end_date   = lubridate::as_date(END_DATE)) %>%
  mutate(level_date = lubridate::as_date(LEVEL_DATE))

# Rename fields
risk <- risk %>%
  rename(cost_risk_color = CONDITIONAL_FORMATTING) %>%
  rename(schedule_risk_color = CONDITIONAL_FORMATTING2)

# Ensure colors are lowercase
risk$cost_risk_color     <- tolower(risk$cost_risk_color)
risk$schedule_risk_color <- tolower(risk$schedule_risk_color)

# Convert factor variables to title case
risk$RISKCATEGORY <- toTitleCase(tolower(risk$RISKCATEGORY))

# Cleanup risk number for sorting
risk <- risk %>%
  mutate(risk_no_risk_cat_code = str_extract(RISK_NO, "\\w+\\b")) %>%
  mutate(risk_no_number_string = str_extract(RISK_NO, "\\b\\w+$")) %>%
  mutate(risk_no_number = str_extract(risk_no_number_string, "\\d+")) %>%
  mutate(risk_no_letter_na = str_extract(risk_no_number_string, "\\D+")) %>%
  mutate(risk_no_letter = replace_na(risk_no_letter_na,
                                     replace = "")) %>%
  mutate(risk_no_padded = str_pad(risk_no_number, 
                                  width = 3, 
                                  side = "left",
                                  pad = "0")) %>%
  mutate(risk_no = str_c(risk_no_risk_cat_code, 
                          "-",
                          risk_no_padded,
                          risk_no_letter))

# Remove unused fields
risk <- risk %>%
  select(!c(PDT_DISC_CONC, PDT_DISC_LIKELI_IMPACT, 
            PDT_DISC_RISK_MANAG_STRATEGY, ACTION_ITEMS, LESSONS_LEARNED, 
            START_DATE, END_DATE, LEVEL_DATE, FK_TABLE_ID,
            risk_no_risk_cat_code, risk_no_number_string, risk_no_number,
            risk_no_letter_na, risk_no_letter, risk_no_padded))

# Create hyperlink to Risk_No
risk <- risk %>%
  mutate(risk_no_link = paste0("[", risk$risk_no, "](#", 
                               tolower(risk$risk_no), ")"))

# Reorder fields
risk <- risk %>%
  relocate(CONCERNS, .after = RISK_NO) %>%
  relocate(COST_RISK, .after = COST_IMPACT_PER_PROJECT) %>%
  relocate(cost_risk_color,  .after = COST_RISK) %>%
  relocate(SCHEDULE_RISK, .after = SCHEDULE_IMPACT_PER_PROJECT) %>%
  relocate(schedule_risk_color, .after = SCHEDULE_RISK) %>%
  relocate(TIMING_OF_DELAY, .after = RISK_STRATEGY) %>%
  relocate(start_date, .after = CONCERNS) %>%
  relocate(end_date, .after = start_date) %>%
  relocate(risk_no, .after = RISK_NO) %>%
  relocate(risk_no_link, .after = risk_no)

# Sort
risk <- risk %>%
  arrange(risk_no)

# Cleanup
rm(risk_oracle)
```

```{r wrangle-events, echo=FALSE, warning=FALSE, message=FALSE}
events_oracle <- read_csv(file = "data/Events_20210928.csv")

# Set date fields
events <- events_oracle %>%
  mutate(level_date = lubridate::as_date(LEVEL_DATE)) %>%
  mutate(created_date   = lubridate::as_date(CREATED_DATE)) %>%
  mutate(last_edited_date = lubridate::as_date(LAST_EDITED_DATE)) 

# Cleanup risk number for sorting
events <- events %>%
  mutate(fk_table_id_cat_code = str_extract(FK_TABLE_ID, "\\w+\\b")) %>%
  mutate(fk_table_id_number_string = str_extract(FK_TABLE_ID, "\\b\\w+$")) %>%
  mutate(fk_table_id_number = str_extract(fk_table_id_number_string, "\\d+")) %>%
  mutate(fk_table_id_letter_na = str_extract(fk_table_id_number_string, "\\D+")) %>%
  mutate(fk_table_id_letter = replace_na(fk_table_id_letter_na,
                                         replace = "")) %>%
  mutate(fk_table_id_padded = str_pad(fk_table_id_number, 
                                      width = 3, 
                                      side = "left",
                                      pad = "0")) %>%
  mutate(fk_table_id = str_c(fk_table_id_cat_code, 
                             "-",
                             fk_table_id_padded,
                             fk_table_id_letter))

# Remove unused fields
events <- events %>%
  select(!c(LEVEL_DATE, CREATED_DATE, LAST_EDITED_DATE, 
            fk_table_id_cat_code, fk_table_id_number_string, fk_table_id_number,
            fk_table_id_letter_na, fk_table_id_letter, fk_table_id_padded))

# Reorder fields
events <- events %>%
  relocate(fk_table_id, .after = FK_TABLE_ID) %>%
  relocate(DESCRIPTION, .after = fk_table_id) %>%
  relocate(level_date, .after = ENG_LEVEL) %>%
  relocate(created_date, .after = CREATED_USER) %>%
  relocate(last_edited_date, .after = LAST_EDITED_USER)

# Sort
events <- events %>%
  arrange(TABLE_NAME, level_date)

# Cleanup
rm(events_oracle)
```

```{r wrangle-discussion, echo=FALSE, warning=FALSE, message=FALSE}
discussion_oracle <- read_csv(file = "data/DiscussionLog_20210928.csv")

# Set date fields
discussion <- discussion_oracle %>%
  mutate(log_date = lubridate::as_datetime(LOG_DATE)) %>%
  mutate(created_date   = lubridate::as_date(CREATED_DATE)) %>%
  mutate(last_edited_date = lubridate::as_date(LAST_EDITED_DATE)) %>%
  mutate(poc_review_date = lubridate::as_date(POC_REVIEW_DATE))

discussion <- discussion %>%
  mutate(fk_table_id_cat_code = str_extract(FK_TABLE_ID, "\\w+\\b")) %>%
  mutate(fk_table_id_number_string = str_extract(FK_TABLE_ID, "\\b\\w+$")) %>%
  mutate(fk_table_id_number = str_extract(fk_table_id_number_string, "\\d+")) %>%
  mutate(fk_table_id_letter_na = str_extract(fk_table_id_number_string, "\\D+")) %>%
  mutate(fk_table_id_letter = replace_na(fk_table_id_letter_na,
                                         replace = "")) %>%
  mutate(fk_table_id_padded = str_pad(fk_table_id_number, 
                                      width = 3, 
                                      side = "left",
                                      pad = "0")) %>%
  mutate(fk_table_id = str_c(fk_table_id_cat_code, 
                             "-",
                             fk_table_id_padded,
                             fk_table_id_letter))

# Remove unused fields
discussion <- discussion %>%
  select(!c(LOG_DATE, CREATED_DATE, LAST_EDITED_DATE, POC_REVIEW_DATE,
            fk_table_id_cat_code, fk_table_id_number_string, fk_table_id_number,
            fk_table_id_letter_na, fk_table_id_letter, fk_table_id_padded))

# Reorder fields
discussion <- discussion %>%
  relocate(fk_table_id, .after = FK_TABLE_ID) %>%
  relocate(log_date, .after = LOGGED_BY) %>%
  relocate(created_date, .after = CREATED_USER) %>%
  relocate(last_edited_date, .after = LAST_EDITED_USER) %>%
  relocate(RESPONSIBLE_POC, .after = log_date) %>%
  relocate(poc_review_date, .after = RESPONSIBLE_POC) %>%
  relocate(ACTIVE, .after = poc_review_date)

# Cleanup
rm(discussion_oracle)
```

```{r wrangle-domains, echo=FALSE, warning=FALSE, message=FALSE}
domains_oracle <- read_csv(file = "data/Domains_20210928.csv")


```

