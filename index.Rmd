--- 
title: "Brandon Road Interbasin Project Risk Analysis Report"
author: "USACE Rock Island District"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
description: "Report description goes here."
bibliography: [book.bib, packages.bib]
biblio-style: apalike
csl: chicago-fullnote-bibliography.csl
---

# Introduction {-}

## Project 
* P2 project name: Brandon Rd-Great Lakes/Miss Rvr Interbasin
* P2 project number: 482782
* P2 program code: 451617

## Architecture
This report using the following architecture:  

* **Data Entry** - An [Oracle APEX](https://apex.oracle.com/) web-database application stores the risk analysis data and allows project risk managers to enter and edit the data. This application resides on the USACE intranet (CorpsNet) and is only available for editing to project risk managers.  
* **Reporting** - This report is produced using [R]()  
* **Code Repository** -   
* **Static Website Publishing** -   
* **Project Viewer** -   

```{r, echo=FALSE, warning=FALSE, message=FALSE, out.width="100%", fig.cap="Report Architecture"}
knitr::include_graphics(path = "diagrams/cloud_arch-workflow.drawio.svg")
```


<!-- Libraries -->
```{r library, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(knitr)
library(rmarkdown)
library(rlang)
library(lubridate)
library(tools)
library(kableExtra)
library(pander)
library(timevis)
library(treemapify)
library(gridExtra)
library(formattable)
```

```{r source, echo=FALSE, warning=FALSE, message=FALSE}
source("R/risk_register_table.R")
source("R/atx_header.R")
source("R/pandoc_header.R")
source("R/percent_treemap.R")
source("R/timeline.R")
source("R/format_id.R")
source("R/id_link.R")
```

<!-- chunk options -->
```{r chunk-opts, echo=FALSE, warning=FALSE, message=FALSE}
options(width = 60)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE
  )
```

<!-- Report Constants -->
```{r, echo=FALSE, warning=FALSE, message=FALSE}
qa_email_address <- "Marisa.C.Lack@usace.army.mil"
```

<!-- Wrangle Data -->
```{r wrangle-risk, echo=FALSE, warning=FALSE, message=FALSE}
risk_oracle <- read_csv(file = "data/RR_MAIN_REPORT_VIEW_20211126.csv")

# Filter for "Active" records
risk <- risk_oracle %>%
  filter(ACTIVE == "Yes")

# Convert date character fields to POSIXct and format format for date
risk <- risk %>%
  mutate(start_date      = lubridate::dmy_hms(START_DATE)) %>%
  mutate(end_date        = lubridate::dmy_hms(END_DATE)) %>%
  mutate(level_date      = lubridate::dmy_hms(LEVEL_DATE)) %>%
  mutate(poc_review_date = lubridate::dmy_hms(POC_REVIEW_DATE))

# Rename fields
risk <- risk %>%
  rename(cost_risk_color = CONDITIONAL_FORMATTING) %>%
  rename(schedule_risk_color = CONDITIONAL_FORMATTING2)

# Set engagement level integer, risk_cat_code
risk <- risk %>%
  mutate(eng_level = as.numeric(str_extract(ENG_LEVEL, "\\d")),
         risk_cat_code = str_extract(RISK_NO, "\\w+\\b"))

# Ensure colors are lowercase
risk$cost_risk_color     <- tolower(risk$cost_risk_color)
risk$schedule_risk_color <- tolower(risk$schedule_risk_color)

# Calculate efficacy_risk_color
risk$efficacy_risk_color <- recode(risk$EFFICACY_RISK,
                                   Low = "green",
                                   Moderate = "orange",
                                   High = "red")

# Add efficacy_impact_per_project
risk$EFFICACY_IMPACT_PER_PROJECT <- ""

# Convert factor variables to title case
risk$RISKCATEGORY <- toTitleCase(tolower(risk$RISKCATEGORY))

# Cleanup risk number for sorting
risk <- format_id(risk, "RISK_NO")

# Remove unused fields
risk <- risk %>%
  select(!c(PDT_DISC_CONC, PDT_DISC_LIKELI_IMPACT,
            PDT_DISC_RISK_MANAG_STRATEGY, ACTION_ITEMS, LESSONS_LEARNED,
            START_DATE, END_DATE, LEVEL_DATE, POC_REVIEW_DATE, 
            FK_TABLE_ID))

# Create hyperlink to Risk_No
risk <- id_link(risk, "risk_no")

# Reorder fields
risk <- risk %>%
  relocate(CONCERNS, .after = RISK_NO) %>%
  relocate(COST_RISK, .after = COST_IMPACT_PER_PROJECT) %>%
  relocate(cost_risk_color,  .after = COST_RISK) %>%
  relocate(SCHEDULE_RISK, .after = SCHEDULE_IMPACT_PER_PROJECT) %>%
  relocate(schedule_risk_color, .after = SCHEDULE_RISK) %>%
  relocate(EFFICACY_IMPACT, .after = EFFICACY_LIKELIHOOD) %>%
  relocate(EFFICACY_IMPACT_PER_PROJECT, .after = EFFICACY_IMPACT) %>%
  relocate(efficacy_risk_color, .after = EFFICACY_RISK) %>%
  relocate(TIMING_OF_DELAY, .after = RISK_STRATEGY) %>%
  relocate(start_date, .after = CONCERNS) %>%
  relocate(end_date, .after = start_date) %>%
  relocate(poc_review_date, .after = RESPONSIBLE_POC) %>%
  relocate(eng_level, .after = ENG_LEVEL) %>%
  relocate(risk_cat_code, .after = RISKCATEGORY)

# Remove duplicates and sort
risk <- risk %>%
  distinct(risk_no, .keep_all = TRUE) %>%
  arrange(risk_no)

# Cleanup
#rm(risk_oracle)
```

```{r wrangle-risk-related-risk, echo=FALSE, warning=FALSE, message=FALSE}
risk_rel_risk_oracle <- read_csv(file = "data/REL_RISK_RISK_MAIN_VIEW_20211126.csv")

# Filter for "Active" records
risk_rel_risk <- risk_rel_risk_oracle %>%
  filter(ACTIVE == "Yes")

# Convert factor variables to title case
risk_rel_risk$RELATED_RISK_CATEGORY <- toTitleCase(tolower(risk_rel_risk$RELATED_RISK_CATEGORY))

# Cleanup id numbers for sorting
risk_rel_risk <- format_id(risk_rel_risk, "RISK_NO")
risk_rel_risk <- format_id(risk_rel_risk, "RELATED_RISK")

# Create hyperlink to Related Risk
risk_rel_risk <- id_link(risk_rel_risk, "related_risk")

# Cleanup
rm(risk_rel_risk_oracle)
```

```{r wrangle-events, echo=FALSE, warning=FALSE, message=FALSE}
events_oracle <- read_csv(file = "data/EVENTS_EVW_20211126.csv")

# Set date fields
events <- events_oracle %>%
  mutate(level_date = dmy_hms(LEVEL_DATE)) %>%
  mutate(level_date = formattable(level_date, format = "%Y-%m-%d"))

# Set engagement level integer field
events <- events %>%
  mutate(eng_level = as.numeric(str_extract(ENG_LEVEL, "\\d")))

# Cleanup risk number for sorting
events <- format_id(events, "FK_TABLE_ID")

# Remove unused fields
events <- events %>%
  select(!c(LEVEL_DATE, CREATED_USER, CREATED_DATE, 
            LAST_EDITED_USER, LAST_EDITED_DATE))

# Reorder fields
events <- events %>%
  relocate(fk_table_id, .after = FK_TABLE_ID) %>%
  relocate(DESCRIPTION, .after = fk_table_id) %>%
  relocate(level_date, .after = ENG_LEVEL) %>%
  relocate(eng_level, .after = ENG_LEVEL)

# Sort
events <- events %>%
  arrange(TABLE_NAME, level_date)

# Cleanup
rm(events_oracle)
```

```{r wrangle-discussion, echo=FALSE, warning=FALSE, message=FALSE}
discussion_oracle <- read_csv(file = "data/R_DISC_LOG_MAIN_REPORT_VIEW_20211126.csv")

# Filter for "Active" records
discussion <- discussion_oracle %>%
  filter(ACTIVE == "Yes")

# Set date fields
discussion <- discussion %>%
  mutate(poc_review_date = lubridate::dmy_hms(POC_REVIEW_DATE))

# Cleanup discussion number for sorting
discussion <- format_id(discussion, "FK_TABLE_ID")

# Remove unused fields
discussion <- discussion %>%
  select(!c(POC_REVIEW_DATE))

# Reorder fields
discussion <- discussion %>%
  relocate(fk_table_id, .after = FK_TABLE_ID) %>%
  relocate(RESPONSIBLE_POC, .after = DISCUSSION) %>%
  relocate(poc_review_date, .after = RESPONSIBLE_POC)

# Cleanup
rm(discussion_oracle)
```

```{r wrangle-action, echo=FALSE, warning=FALSE, message=FALSE}
action_oracle <- read_csv(file = "data/ACTION_REGISTER_EVW_20211126.csv")

# Filter for "Active" records
action <- action_oracle %>%
  filter(ACTIVE == "Yes")

# Convert date character fields to POSIXct and format format for date
action <- action %>%
  mutate(start_date      = lubridate::dmy_hms(START_DATE)) %>%
  mutate(end_date        = lubridate::dmy_hms(END_DATE)) %>%
  mutate(poc_review_date = lubridate::dmy_hms(POC_REVIEW_DATE))

# Cleanup action number for sorting
action <- format_id(action, "ACTION_NO")

# Create hyperlink
action <- id_link(action, "action_no")

# Remove unused fields
action <- action %>%
  select(!c(START_DATE, END_DATE, POC_REVIEW_DATE,
            CREATED_USER, CREATED_DATE, LAST_EDITED_USER, LAST_EDITED_DATE))

# Reorder fields
action <- action %>%
  relocate(start_date, .after = ACTION) %>%
  relocate(end_date, .after = start_date) %>%
  relocate(poc_review_date, .after = RESPONSIBLE_POC)

# Remove duplicates and sort
action <- action %>%
  distinct(action_no, .keep_all = TRUE) %>%
  arrange(action_no)

# Cleanup
rm(action_oracle)
```

```{r wrangle-action-related-action, echo=FALSE, warning=FALSE, message=FALSE}
action_rel_risk_oracle <- read_csv(file = "data/REL_RISK_ACTION_MAIN_VIEW_20211126.csv")

# Relocate the ACTION columns to the beginning
action_rel_risk <- action_rel_risk_oracle %>%
  select(contains("ACTION"), everything())

# Convert factor variables to title case
action_rel_risk$RISKCATEGORY <- toTitleCase(tolower(action_rel_risk$RISKCATEGORY))

# Cleanup id fields for sorting
action_rel_risk <- format_id(action_rel_risk, "ACTION_NO")
action_rel_risk <- format_id(action_rel_risk, "RISK_NO")

# Create hyperlink
action_rel_risk <- id_link(action_rel_risk, "risk_no")

# Cleanup
rm(action_rel_risk_oracle)
```

```{r create_timevis_df, echo=FALSE, warning=FALSE, message=FALSE}
# Create a timevis "data" data frame of risks
risk_time <- risk %>%
  arrange(risk_no) %>%
  select(OBJECTID, risk_no, start_date, end_date, risk_cat_code, 
         CONCERNS, COMPONENT, RESPONSIBLE_POC, eng_level) %>%
  rename(id = OBJECTID) %>%
  rename(content = risk_no) %>%
  relocate(id, .before = content) %>%
  rename(start = start_date) %>%
  rename(end = end_date) %>%
  rename(title = CONCERNS) %>%
  relocate(title, .after = content) %>%
  mutate(group = as.numeric(factor(risk_cat_code))) %>%
  relocate(group, .after = end)

# Create a timevis "group" data frame to group risks by unique Risk Categories
risk_time_riskcategory <- risk %>%
  select(risk_cat_code, RISKCATEGORY) %>%
  mutate(id = as.numeric(factor(risk_cat_code))) %>%
  rename(content = risk_cat_code) %>%
  rename(title = RISKCATEGORY) %>%
  relocate(id, .before = content) %>%
  distinct(id, content, .keep_all = TRUE)
```

